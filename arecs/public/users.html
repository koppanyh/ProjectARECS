<!DOCTYPE HTML>
<html>
	<head>
		<title>ARECS - Employee Management</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="icon" href="/images/stop-watch.png">
		<link rel="stylesheet" type="text/css" href="/style.css">
		<script type="text/javascript" src="/ractive.js"></script>
		<script type="text/javascript" src="/core.js"></script>
		<style>
			.card {
				display: inline-block;
				background-color: #FDD;
				border: 1px solid black;
				border-radius: 5px;
				margin: 10px;
				padding: 10px;
				text-align: center;
			}
		</style>
	</head>
	<body id="body"></body>
</html>

<script id="template" type="text/ractive">
	<nav>
		<img id="logo" src="/images/logo.png">
		<a href="/account/user.html"><img id="profilepic" src="/userpics/{{ppic}}"></a><br>
		<a href="/">Home</a>&nbsp;&nbsp;
		<a href="" on-click="newuser">New User</a>
	</nav>
	
	<div style="padding: 5px">
		Pay Period: <input type="date" value="{{pstart}}"> to <input type="date" value="{{pend}}">
		<button on-click="money">Update</button><br>
		<!--button>Export Financial Data</button>
	</div>
	
	<div>
		Graph of employee work-->
	</div>
	
	<div style="text-align: center">
		<b>Employees</b><br>
		{{#each employees}}
		<a href="/viewprofile.html?id={{uid}}"><div class="card"
			style="background-color: {{#if isclocked[uid]}}#DFD{{else}}#FDD{{/if}}">
			<img src="/userpics/{{picture}}" style="height: 100px; border-radius: 4px"><br>
			{{lname}}, {{fname}}<br>
			{{email}}<br>
			{{#if wage < 0}}${{Math.abs(wage).toFixed(2)}}{{else}}
			${{((hours[uid] ? hours[uid] : 0) * wage).toFixed(2)}}{{/if}}
			<br>
			{{#if hours[uid]}}{{hours[uid].toFixed(2)}}{{else}}0{{/if}} hours
		</div></a>
		{{/each}}
	</div><br><br>
	
	<div on-click="closemodal" style="display: {{modla}}">
		<div class="modal"></div>
		<img src="images/loading.gif" class="loading">
	</div>
</script>

<script>
	var userdict = {};
	var lastweek = new Date();
	lastweek.setTime(lastweek.getTime() - 13*24*3600*1000);
	
	var ractive = new Ractive({
		target: '#body',
		template: '#template',
		data: {
			modla: "",
			isAdmin: false,
			ppic: "user.png",
			employees: [{picture: "user.png", fname: "Loading",
				lname: "Loading", email: "Loading", uid: 0, wage: 0}],
			hours: {}, //[uid]: 0
			pstart: getdate(lastweek),
			pend: getdate(),
			isclocked: {}
		},
		oninit: function(){
			this.on("closemodal", function(event){
				//this.set("modla", "none");
			});
			this.on("money", function(event){
				ractive.set("modla", "");
				var req = "/api?action=gethours&allemployees&fromday="+event.get("pstart")+"&today="+event.get("pend");
				httpRequest("GET",req,"",function(http){
					var result = JSON.parse(http.responseText);
					checkError(result);
					var hrs = {};
					result.forEach(function(itm){
						if(itm.uid in hrs) hrs[itm.uid] += itm.hours;
						else hrs[itm.uid] = itm.hours;
					});
					ractive.set("hours", hrs);
					ractive.set("modla", "none");
					console.log("Hours", result, hrs);
				});
			});
			this.on("newuser", function(event){
				if(confirm("Create new user")){
					this.set("modla","");
					httpRequest("POST","/account","action=newuser",function(http){
						var result = JSON.parse(http.responseText);
						checkError(result);
						console.log(result);
						document.location = "/viewprofile.html?id=" + result.insertId;
					});
				}
				return false;
			});
		},
	});
	
	var lock1 = false;
	httpRequest("POST","/account","action=getuser",function(http){
		if(http.responseText == "") document.location = "/account";
		else{
			userdict = JSON.parse(http.responseText);
			checkError(userdict);
			if(!userdict.admin) document.location = "/account";
			else{
				ractive.set("ppic", userdict.picture);
				ractive.set("isAdmin", userdict.admin);
				console.log(userdict);
			}
		}
		lock1 = true;
	});
	
	var lock2 = false;
	var lock4 = false;
	httpRequest("GET","/api?action=getemployees","",function(http){
		if(http.responseText != ""){
			var employees = JSON.parse(http.responseText);
			checkError(employees);
			if(employees[0].error){
				ractive.set("employees[0].fname", "Database");
				ractive.set("employees[0].lname", "Error");
			} else{
				employees.sort(function(a,b){
					a = a.lname + " " + a.fname;
					b = b.lname + " " + b.fname;
					if(a < b) return -1;
					if(a > b) return 1;
					return 0;
				});
				ractive.set("employees", employees);
				console.log("Employees", employees);
			}
		}
		lock2 = true;
		
		httpRequest("GET","/api?action=gethours&allemployees&fromday="+getdate(),"",function(http){
			var result = JSON.parse(http.responseText);
			checkError(result);
			var clocked = {};
			result.forEach(function(itm){
				if(itm.tend == null) clocked[itm.uid] = true;
			});
			ractive.set("isclocked", clocked);
			console.log("OUTPUT:", result, clocked);
			lock4 = true;
		});
	});
	
	var lock3 = false;
	httpRequest("GET","/api?action=gethours&allemployees&fromday="+getdate(lastweek),"",function(http){
		var result = JSON.parse(http.responseText);
		checkError(result);
		var hrs = {};
		result.forEach(function(itm){
			if(itm.uid in hrs) hrs[itm.uid] += itm.hours;
			else hrs[itm.uid] = itm.hours;
		});
		ractive.set("hours", hrs);
		console.log("Hours", result, hrs);
		lock3 = true;
	});
	
	var modalIntv = setInterval(function(){
		if(lock1 && lock2 && lock3 && lock4){
			ractive.set("modla", "none");
			clearInterval(modalIntv);
		}
	}, 250);
</script>
